# Gothic Gateway

A GraphQL federation gateway using WunderGraph Cosmo Router with support for Claude service, Git service, and GitHub operations.

## Overview

This gateway federates the following services:
- **claude-service** (port 3002): Claude AI integration and operations
- **git-service** (port 3004): Git operations and repository management  
- **github-adapter** (port 3005): GitHub API GraphQL wrapper

## Architecture

The gateway uses a dual-configuration approach:
- **`config.json`**: Execution configuration (generated by wgc from subgraph SDLs)
- **`config.yaml`**: Runtime configuration (timeouts, CORS, logging, etc.)

## Features

- **GraphQL Federation v2**: Unified schema using WunderGraph Cosmo
- **SSE Subscriptions**: Real-time updates via Server-Sent Events
- **Extended Timeouts**: 25-minute timeout for Claude CLI operations
- **Health Monitoring**: Service health checks with unified status
- **CORS Support**: Configured for UI access
- **Telemetry**: Prometheus metrics and tracing support

## Getting Started

### Prerequisites

Ensure all federated services are running:
```bash
pm2 status
# Should show:
# - claude-service (port 3002)
# - git-service (port 3004)
# - github-adapter (port 3005)
```

### Configuration

1. **Generate the execution config** (when schemas change):
```bash
./generate-config.sh
```

2. **Modify runtime settings** in `config.yaml`:
   - Timeouts: See `traffic_shaping` section
   - CORS: Update `cors.allow_origins`
   - Logging: Adjust `log_level`

### Running the Gateway

```bash
# Using PM2 (recommended)
pm2 start gateway

# Or directly
./start.sh
```

The gateway will be available at:
- GraphQL endpoint: `http://localhost:4000/graphql`
- GraphQL playground: `http://localhost:4000/`
- Health check: `http://localhost:4000/health`
- Metrics: `http://localhost:4000/metrics`

## Timeout Configuration

Service-specific timeouts are configured in `config.yaml`:

```yaml
traffic_shaping:
  subgraphs:
    claude-service:
      request_timeout: 1500s  # 25 minutes for Claude CLI
    # Other services use the default 60s timeout
```

See [TIMEOUT-CONFIGURATION.md](./TIMEOUT-CONFIGURATION.md) for details.

## Example Queries

### Unified Health Check
```graphql
query HealthCheck {
  health {
    healthy
    service
    version
    timestamp
    details
  }
}
```

### Cross-Service Query
```graphql
query GetRepositoryWithAI {
  # From git-service
  gitStatus(path: "/path/to/repo") {
    branch
    files {
      path
      status
    }
  }
  
  # From claude-service
  sessions {
    id
    status
    workingDirectory
  }
}
```

### Generate Commit Messages (Long-running)
```graphql
mutation GenerateCommitMessages($input: BatchCommitMessageInput!) {
  generateCommitMessages(input: $input) {
    results {
      repositoryName
      success
      message
      confidence
    }
  }
}
```

### Real-time Subscriptions
```graphql
subscription WatchClaudeOutput($sessionId: ID!) {
  commandOutput(sessionId: $sessionId) {
    type
    content
    timestamp
    isFinal
  }
}
```

## Troubleshooting

### Gateway won't start
- Check logs: `pm2 logs gateway`
- Verify all services are running: `pm2 status`
- Ensure config files exist: `config.json` and `config.yaml`

### Timeout errors
- Check if the operation needs > 60s (default timeout)
- Verify claude-service has 25-minute timeout in `config.yaml`
- Monitor logs for "Failed to fetch from Subgraph" errors

### Regenerating configuration
When subgraph schemas change:
```bash
./generate-config.sh
pm2 restart gateway
```

## Development

### Adding a new subgraph
1. Ensure the service implements Federation v2
2. Add it to the port checks in `generate-config.sh`
3. Run `./generate-config.sh`
4. Add service-specific timeouts to `config.yaml` if needed
5. Restart the gateway

### Monitoring
- Prometheus metrics: `http://localhost:4000/metrics`
- Health endpoint: `http://localhost:4000/health`
- PM2 monitoring: `pm2 monit`

## Files

- `generate-config.sh` - Generates execution config from subgraph SDLs
- `config.yaml` - Runtime configuration (timeouts, CORS, etc.)
- `config.json` - Generated execution config (DO NOT EDIT)
- `start-router-pm2.sh` - PM2 startup script
- `.gitignore` - Prevents committing generated files